---
title: "Analyses"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: "cosmo"
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load packages and data

```{r}

# 1. Load packages ----

library(magrittr)
library(tidyverse) # Core tidyverse packages
library(sf)
sf_use_s2(FALSE) # Switch from S2 to GEOS
library(ggstream)
library(patchwork)
library(cowplot)
library(ggsflabel)
library(ggtext)
library(glue)
library(ggrepel)
library(FactoMineR) # For PCA
library(RColorBrewer)
library(ggforce)# For geom_circle

# 2. Source functions ----

source("functions/graphical_par.R")
source("functions/theme_map.R")
source("functions/theme_graph.R")
theme_set(theme_graph())

# 3. Load MEOW data ----

load(file = "../data/04_meow-with-coral-reefs.RData")

# 4. Load 2020 GCRMN report synthetic dataset ----

data_gcrmn <- read.csv2(file = "../data/03-merge_all_all_all_benthos_NA.csv") %>% 
  # Remove data
  filter(!(DatasetID %in% c("XLCA1", "XLCA2", "XLCA3", "XLCA4", "XLCA5"))) %>% # XL Catlin Seaview
  filter(Year <= 2018) %>% # Data after 2018   
  drop_na(Latitude, Longitude) %>% # NA for Lat/Long
  # Sites with incorrect position (not corrected during QAQC)
  filter(!(Longitude %in% c(33.50138889, 52.7500, 50.71666667))) %>% 
  filter(!(Site %in% c("34.26.62E.28.51.79S", "34.41.08E.27.31.66S", "NSIslandsSouth", 
                       "29N34E4", "34.4.4.97E.29.7.39.89N", "34.26.013E.28.26.151N", "34.18.5E27.54.8N"))) %>% 
  # Add data sources
  left_join(., read.csv2("../data/05_data-sources.csv")) %>% 
  mutate(Source = str_replace_all(Source, c("Research Institute and University" = "Research institute and university")),
         Source = as.factor(Source))

# 5. Remove sites falling outside MEOW containing coral reefs ----

data_gcrmn <- data_gcrmn %>% 
  mutate(lat = Latitude, 
         long = Longitude) %>% 
  st_as_sf(., coords = c("long", "lat"), crs = 4326) %>% 
  st_join(., data_meowreefs) %>% 
  drop_na(ECOREGION) %>% 
  st_drop_geometry() %>% 
  select(-ECOREGION:-SHAPE_Area)

# 6. Summarize by duration ----

data_gcrmn_sites <- data_gcrmn %>% 
  group_by(Area, Country, Location, Site, Latitude, Longitude) %>% 
  drop_na(Year) %>% 
  summarise(interval_years = max(Year, na.rm = TRUE) - min(Year, na.rm = TRUE)) %>%
  ungroup() %>% 
  mutate(interval_class = cut(interval_years, 
                              breaks = c(-Inf, 1, 5, 10, 15, Inf),
                              labels = c("1", "2-5", "6-10", "11-15", ">15"))) %>% 
  st_as_sf(., coords = c("Longitude", "Latitude"), crs = 4326) %>% 
  st_transform(., crs = crs_selected)

```

# Figures

## Figure 1

```{r fig.height=3, fig.width=8}

# 1. Load background maps and change its CRS ----

# 1.1 Load shapefile --

data_map <- read_sf("../data/00_natural-earth-data/ne_10m_land/ne_10m_land.shp") %>% 
  st_transform(crs = 4326)

# 1.2 Define the offset --

correction_offset <- 180 - 160 # Here 160 is the same value than +lon_0 from crs_selected

# 1.3 Define a long and slim polygon that overlaps the meridian line --

correction_polygon <- st_polygon(x = list(rbind(c(-0.0001 - correction_offset, 90),
                                                c(0 - correction_offset, 90),
                                                c(0 - correction_offset, -90),
                                                c(-0.0001 - correction_offset, -90),
                                                c(-0.0001 - correction_offset, 90)))) %>%
  st_sfc() %>%
  st_set_crs(4326)

# 1.4 Modify data_map to remove overlapping portions using correction_polygon --

data_map_160 <- data_map %>% 
  st_difference(correction_polygon) %>% 
  st_transform(crs_selected)

# 2. Change data_meowreefs CRS ----

data_meowreefs <- data_meowreefs %>%
  st_transform(crs_selected)

data_meowreefs %<>% # Special pipe from magrittr
  st_buffer(100) # To join polygon (remove vertical line on 180°)

# 3. Make the map ----

ggplot() +
  # MEOW
  geom_sf(data = data_meowreefs, fill = "white", col = col_color_map, size = 0.5) +
  # Site of benthic cover data
  geom_sf(data = data_gcrmn_sites, aes(color = interval_class), size = 1) +
  # Background map
  geom_sf(data = data_map_160, size = 0.25) +
  coord_sf(ylim = c(-5000000, 5000000), expand = FALSE) +
  guides(colour = guide_legend(title.position = "top", title.hjust = 0.5, override.aes = list(size = 5))) +
  scale_color_manual(values = palette_5cols) +
  theme_map() +
  labs(col = "Monitoring duration (years)")

# 4. Save the map ----

ggsave("../figs/01_figure-1.png", height = 3, width = 8, dpi = 600)

```

## Figure 2

```{r}

# 1. Surveys by year ----

# 1.1 Modify the data --

data_year <- data_gcrmn %>% 
  select(Latitude, Longitude, Date, Year) %>% 
  distinct(.)

# 1.2 Make the plot --

plot_year <- ggplot(data_year, aes(x = Year)) +
  # By default its density, width*density*100 gives percentage
  geom_histogram(binwidth = 1, aes(y = stat(width*density*100)),
                 color = "black", fill = "#6c7a89") +
  lims(y = c(0, 10), x = c(1979, 2021)) +
  labs(x = "Year", y = "Surveys (%)")

# 2. Surveys by depth ----

# 2.1 Modify the data --

data_depth <- data_gcrmn %>% 
  select(Latitude, Longitude, Date, Year, Depth) %>% 
  distinct(.)

# 2.2 Make the plot --

plot_depth <- ggplot(data = data_depth, aes(x = Depth)) +
  # By default its density, width*density*100 gives percentage
  geom_histogram(binwidth = 1, aes(y = stat(width*density*100)),
                 color = "black", fill = "#6c7a89") +
  lims(x = c(-1, 40), y = c(0, 30)) +
  labs(x = "Depth (m)", y = "Surveys (%)")

# 3. Monitoring duration ----

# 3.1 Transform the data --

data_duration <- data_gcrmn_sites %>% 
  st_drop_geometry() %>% 
  group_by(interval_class) %>% 
  summarise(n_abs = n()) %>% 
  ungroup() %>% 
  mutate(n_rel = (n_abs/sum(n_abs))*100)

# 3.2 Make the plot --

plot_duration <- ggplot(data = data_duration, aes(x = interval_class, y = n_rel)) +
  geom_bar(stat = "identity", aes(fill = interval_class), show.legend = FALSE, col = "black") +
  scale_fill_manual(values = palette_5cols) +
  lims(y = c(0, 100)) +
  labs(x = "Monitoring duration (years)", y = "Sites (%)")

# 4. Make the assembled plot ----

plot_grid(plot_duration, plot_year, plot_depth, nrow = 1, labels = c("A", "B", "C"))

# 5. Save the plot ----

ggsave(filename = "../figs/01_figure-2.png", height = 3.5, width = 12, dpi = 600)

# 6. Remove useless objects ----

rm(data_depth, plot_depth, data_year, plot_year, data_duration, plot_duration)

# 7. Export tables to include numbers in the manuscript ----

# 7.1 Number of sites by time category --

data_gcrmn_sites %>% 
  st_drop_geometry() %>% 
  select(interval_class) %>% 
  group_by(interval_class) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(percent = (n/sum(n))*100) %>% 
  write.csv2(., file = "../figs/03_number-sites-by-category.csv", row.names = FALSE)

# 7.2 Number of surveys by year --

data_gcrmn %>% 
  select(Latitude, Longitude, Date, Year) %>% 
  distinct(.) %>% 
  group_by(Year) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(percent = (n/sum(n))*100) %>% 
  write.csv2(., file = "../figs/03_number-surveys-by-year.csv", row.names = FALSE)

```

## Figure 3

### Calculation of descriptors

```{r}

# 1. Load and transform Marine Ecoregions of the World (MEOW) data ----

data_meow <- read_sf("../data/02_marine-ecoregions-of-the-world/Marine_Ecoregions_Of_the_World__MEOW_.shp") %>% 
  st_transform(crs = 4326) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES")) %>% 
  st_make_valid()

# 2. Join MEOW and GCRMN data ----

data_gcrmn_meow <- data_gcrmn %>% 
  st_as_sf(., coords = c("Longitude", "Latitude"), crs = 4326) %>% 
  st_intersection(., data_meow) %>% 
  mutate(geometry2 = str_remove_all(geometry, "c|\\(|\\)"),
         Longitude = as.numeric(str_split_fixed(geometry2, ",", 2)[,1]),
         Latitude = as.numeric(str_split_fixed(geometry2, ",", 2)[,2])) %>% 
  st_drop_geometry() %>% 
  select(-geometry2)

# 3. Calculation of sites ----

data_descriptors <- data_gcrmn_meow %>% 
  select(Latitude, Longitude, ECOREGION) %>% 
  distinct() %>% 
  group_by(ECOREGION) %>% 
  summarise(n_sites = n())

# 4. Calculation of observations ----

data_descriptors <- data_gcrmn_meow %>% 
  group_by(ECOREGION) %>% 
  summarise(n_obs = n()) %>% 
  left_join(data_descriptors, .)
  
# 5. Calculation of surveys ----

data_descriptors <- data_gcrmn_meow %>% 
  select(Latitude, Longitude, Date, Year, ECOREGION) %>% 
  distinct() %>% 
  group_by(ECOREGION) %>% 
  summarise(n_surveys = n()) %>% 
  left_join(data_descriptors, .)

# 6. Calculation of monitoring duration ----

data_descriptors <- data_gcrmn_meow %>% 
  group_by(Area, Country, Location, Site, Latitude, Longitude, ECOREGION) %>% 
  summarise(interval_years = max(Year, na.rm = TRUE) - min(Year, na.rm = TRUE)) %>%
  drop_na(interval_years) %>% 
  ungroup() %>% 
  mutate(interval_class = cut(interval_years, 
                              breaks = c(-Inf, 1, 5, 10, 15, Inf),
                              labels = c("n_1", "n_2_5", "n_6_10", "n_11_15", "n_15"))) %>% 
  group_by(ECOREGION, interval_class) %>%
  summarise(n = n()) %>% 
  pivot_wider(names_from = interval_class, values_from = n, values_fill = 0) %>% 
  left_join(data_descriptors, .)

# 7. Number of years with data ---- 

data_descriptors <- data_gcrmn_meow %>% 
  select(ECOREGION, Year) %>% 
  distinct() %>% 
  group_by(ECOREGION) %>% 
  summarise(n_years = n(),
            first_year = min(Year)) %>% 
  ungroup() %>% 
  left_join(data_descriptors, .)

# 8. Add reef surfaces ----

load("../data/04_reef-surface-by-ecoregion.RData")

data_descriptors <- left_join(data_surface, data_descriptors) %>% 
  # Replace NA with 0 for some variables
  mutate_at(vars(starts_with("n_")), ~replace_na(., 0))

# 9. Calculate relative frequency ----

data_descriptors <- data_descriptors %>% 
  pivot_longer("area":"n_years", names_to = "var_names", values_to = "abs") %>% # Select variables to shift in relative freq here
  group_by(var_names) %>% 
  mutate(total = sum(abs)) %>% 
  ungroup() %>% 
  group_by(ECOREGION, var_names) %>% 
  mutate(rel = (abs/total)*100) %>% 
  ungroup() %>% 
  select(-total) %>% 
  pivot_wider(names_from = "var_names", values_from = c("abs", "rel"), names_glue = "{var_names}_{.value}")

```

### Pixel descriptor 

```{r}

# 1. Import data on coral reefs distribution ----

data_reefs <- read_sf("./../data/01_reefs-distribution-unep-wcmc/01_Data/WCMC008_CoralReef2018_Py_v4_1.shp") %>% 
  st_transform(crs = 4326) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES")) %>% 
  st_make_valid()

# 2. Create a grid cells of 1° ----

grid_reefs <- st_make_grid(data_reefs, cellsize = 1) %>% 
  st_as_sf() %>% 
  st_filter(., data_reefs) # Filter grid cells containing coral reefs

# 3. Make intersection with MEOW ----

grid_reefs <- st_intersection(grid_reefs, data_meow)

# 4. Count number of polygon by MEOW ---- 

pixel_total <- grid_reefs %>% 
  st_drop_geometry() %>% 
  group_by(ECOREGION, ECO_CODE_X) %>% 
  count(name = "n_total")

# 5. Count number of polygon with monitoring data by MEOW ---- 

pixel_monitoring <- data_gcrmn_sites %>% 
  st_transform(crs = 4326) %>% 
  st_filter(grid_reefs, .) %>% 
  st_drop_geometry() %>% 
  group_by(ECOREGION, ECO_CODE_X) %>% 
  count(name = "n_monitoring")

# 6. Join with other data descriptors ----

data_descriptors <- left_join(pixel_total, pixel_monitoring) %>% 
  mutate(n_monitoring = replace_na(n_monitoring, replace = 0),
         n_percent = (n_monitoring/n_total)*100) %>% 
  left_join(data_descriptors, .)

# 7. Transform as an sf object ----

data_descriptors <- left_join(as_tibble(data_meowreefs), data_descriptors) %>% 
  st_as_sf() %>% 
  select(-"FID":-"SHAPE_Area", -"area")

# 8. Map of grid reefs to visualize size of pixel ----

# 8.1 Make the map --

ggplot() +
  geom_sf(data = grid_reefs, aes(fill = ECOREGION), show.legend = FALSE) +
  geom_sf(data = data_map) +
  coord_sf(x = c(30, 60), y = c(-30, -5))

# 8.2 Save the map --

ggsave(filename = "../figs/03_map-size-pixel.png", height = 6, width = 8, dpi = 600)

# 9. Remove useless objects ----

rm(data_reefs, grid_reefs, pixel_total, pixel_monitoring, data_meow)

```

### PCA and HCPC

```{r}

# 1. PCA ----

# 1.1 Filter data --

data_descriptors_pca <- as_tibble(data_descriptors) %>% 
  select(ECOREGION, n_sites_abs, n_surveys_abs, first_year, n_15_abs, n_years_abs, n_percent) %>% 
  drop_na(first_year) # Remove ecoregions with no monitoring data

# 1.2 Make the PCA --

res_pca <- PCA(data_descriptors_pca[,-1], ncp = 3, scale.unit = TRUE)

# 2. HCPC ----

# 2.1 Make the HCPC --

# Select the number of clusters to use
# res_hcpc <- HCPC(res_pca, kk = Inf)

# Rerun using the selected number of cluster and consolidate using k-means
res_hcpc <- HCPC(res_pca, nb.clust = 3, consol = TRUE)

# 2.2 Save the plots --

png("./../figs/03_hcpc-tree.png", width = 1600, height = 1600, res = 300)
plot.HCPC(res_hcpc, choice = "tree")
dev.off()

png("./../figs/03_hcpc-map.png", width = 1600, height = 1600, res = 300)
plot.HCPC(res_hcpc, choice = "map")
dev.off()

# 3. Results ----

# 3.1 Print the contributions of variables to each cluster --

res_hcpc$desc.var

# 3.2 Export the results --

write.table(res_hcpc$call$t$inert.gain, "./../figs/02_table-results-hcpc_inertia-gain.txt")
write.csv2(res_hcpc$desc.var$quanti.var, "./../figs/02_table-results-hcpc_link.csv")
write.csv2(res_hcpc$desc.var$quanti$`1`, "./../figs/02_table-results-hcpc_clust3.csv")
write.csv2(res_hcpc$desc.var$quanti$`2`, "./../figs/02_table-results-hcpc_clust2.csv")
write.csv2(res_hcpc$desc.var$quanti$`3`, "./../figs/02_table-results-hcpc_clust1.csv")

```

### Graphical output

```{r}

# 1. Graph of variables ----

# 1.1 Extract and transform the data --

data_var <- as_tibble(res_pca$var$coord) %>% 
  bind_cols(var = rownames(res_pca$var$coord), .) %>% 
  select(var, Dim.1, Dim.2) %>% 
  # Rename variables to make interpretation easier
  mutate(var = str_remove_all(var, "_abs"),
         var = str_replace_all(var, c("n_15" = "n_ltms",
                                      "n_percent" = "pixel_data")))

# Annotation labels for each descriptor (geom_text_repel plot above circle and segment)
annotation_label <- tibble(descriptor = data_var$var,
                           x = c(0.85, 0.75, -0.62, 0.55, 0.70, 0.325),
                           y = c(0.05, 0.25, 0.25, 0.6, -0.4, -0.50))

# 1.2 Make the graph --

plot_var <- ggplot(data = data_var) +
  #geom_text_repel(aes(x = Dim.1, y = Dim.2, label = var), family = font_choose_graph) +
  geom_text(data = annotation_label, aes(x = x, y = y, label = descriptor), family = font_choose_graph, size = 3.5) +
  geom_segment(aes(x = 0, y = 0, xend = Dim.1, yend = Dim.2),
                  arrow = arrow(length = unit(0.25, "cm"))) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  lims(x = c(-1, 1), y = c(-1, 1)) +
  geom_circle(data = data.frame(x0 = 0, y0 = 0, r = 1), # From ggforce package
              aes(x0 = x0, y0 = y0, r = r)) +
  coord_fixed() +
  labs(x = paste0("Dim 1 (", round(res_pca$eig[1,2], 2), "%)"), 
       y = paste0("Dim 2 (", round(res_pca$eig[2,2], 2), "%)"),
       title = "A")

plot_var

ggsave(plot_var, filename = "./../figs/03_pca-graph-var.png", height = 6, width = 6, dpi = 600)

# 2. Graph of individuals ----

# 2.1 Extract and transform the data --

data_hcpc_descriptors <- res_hcpc$data.clust %>% 
  mutate(ind = rownames(.))

data_hcpc_cluster <- res_hcpc$call$X %>% 
  mutate(ind = rownames(.))

data_ind <- left_join(data_hcpc_cluster, data_hcpc_descriptors) %>% 
  left_join(data_descriptors, .) %>% 
  st_as_sf() %>% 
  select(ECOREGION, ECO_CODE_X, Dim.1, Dim.2, clust) %>% 
  # Change numbering of clusters to match with logical order for interpretation
  mutate(clust = as.character(clust),
         clust = replace_na(clust, "4"),
         clust = case_when(clust == "1" ~ "3",
                           clust == "3" ~ "1",
                           TRUE ~ clust))

# Palette of colors for each cluster
palette_cluster <- c("1" = "#2c7bb6",
                     "2" = "#f7ca18",
                     "3" = "#fc8d59",
                     "4" = "white")

# Get the numbers of ecoregions for each cluster
legend_cluster <- data_ind %>%
  st_drop_geometry() %>% 
  group_by(clust) %>% 
  count()

# Legend labels for each cluster (map)
legend_cluster <- c("1" = glue("<b>1.</b> Very high nb. surveys, high temporal ext., high spatial ext. (<i>n</i> = ", 
                               as.character(legend_cluster[1,"n"]),")"),
                    "2" = glue("<b>2.</b> High temporal ext., medium spatial ext. (<i>n</i> = ", 
                               as.character(legend_cluster[2,"n"]),")"),
                    "3" = glue("<b>3.</b> Low nb. surveys, low temporal ext., low spatial ext. (<i>n</i> = ", 
                               as.character(legend_cluster[3,"n"]),")"),
                    "4" = glue("<b>4.</b> Unknown, no data (<i>n</i> = ", 
                               as.character(legend_cluster[4,"n"]),")"))

# Legend labels for each cluster (plot)
annotation_cluster <- tibble(cluster = as.character(c(1:3)),
                             x = c(6.5, 5.5, -1.5),
                             y = c(2.5, -1, -2),
                             col_cluster = c("white", "black", "black"))

# 2.2 Make the graph without clusters colors --

plot_ind <- ggplot(data = data_ind, aes(x = Dim.1, y = Dim.2, label = ECO_CODE_X)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point(size = 4) +
  geom_text_repel(show.legend = FALSE, size = 3, seed = 20, max.overlaps = 5, family = font_choose_graph) +
  labs(x = paste0("Dim 1 (", round(res_pca$eig[1,2], 2), "%)"), 
       y = paste0("Dim 2 (", round(res_pca$eig[2,2], 2), "%)"),
       title = "B")

ggsave(plot_ind, filename = "./../figs/03_pca-graph-ind-without-col.png", height = 6, width = 6, dpi = 600)

plot_var + plot_ind

ggsave(filename = "./../figs/03_pca-graph-combined-without-col.png", height = 5, width = 10, dpi = 600)

# 2.3 With clusters colors --

plot_ind_col <- ggplot(data = data_ind, aes(x = Dim.1, y = Dim.2, label = ECO_CODE_X, fill = clust)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point(show.legend = FALSE, size = 4, shape = 21, col = "black") +
  geom_text_repel(show.legend = FALSE, size = 3, seed = 20, max.overlaps = 5, family = font_choose_graph) +
  labs(x = paste0("Dim 1 (", round(res_pca$eig[1,2], 2), "%)"), 
       y = paste0("Dim 2 (", round(res_pca$eig[2,2], 2), "%)"),
       title = "B") +
  geom_label(data = annotation_cluster, aes(x = x, y = y, label = paste("Cluster", cluster), 
                                            fill = cluster, color = col_cluster), 
             label.r = unit(0, "lines"), label.size = 0, show.legend = FALSE, alpha = 0.75, family = font_choose_graph) +
  scale_fill_manual(values = palette_cluster) +
  scale_color_identity()

ggsave(plot_ind_col, filename = "./../figs/03_pca-graph-ind-with-col.png", height = 6, width = 6, dpi = 600)

plot_var + plot_ind_col

ggsave(filename = "./../figs/01_figure-3.png", height = 5, width = 10, dpi = 600)

```

## Figure 4

```{r}

# 1. Map with all clusters ----

# 1.1 Make the map --

ggplot() +
  # Clusters
  geom_sf(data = data_ind, aes(fill = clust)) +
  # Background map
  geom_sf(data = data_map_160, size = 0.25) +
  coord_sf(ylim = c(-5000000, 5000000), expand = FALSE) +
  guides(fill = guide_legend(title.position = "top", title.hjust = 0)) +
  theme_map() +
  theme(legend.position = "top", 
        legend.direction = "vertical",
        legend.title = element_text(face = "bold"),
        legend.text = element_markdown()) +
  scale_fill_manual(values = palette_cluster, labels = legend_cluster, name = "Cluster and interpretation")

# 1.2 Save the map --

ggsave(filename = "./../figs/01_figure-4.png", height = 4, width = 9, dpi = 600)

# 2. Map by cluster ----

for(i in 1:4){
  
  # 2.1 Make the map --

  ggplot() +
  # MEOW
  geom_sf(data = data_meowreefs, fill = "transparent") +
  # Clusters
  geom_sf(data = data_ind %>% filter(clust == as.character(i)), aes(fill = clust)) +
  # Background map
  geom_sf(data = data_map_160) +
  coord_sf(ylim = c(-5000000, 5000000), expand = FALSE) +
  guides(fill = guide_legend(title.position = "top", title.hjust = 0)) +
  theme_map() +
  theme(legend.position = "top", 
        legend.direction = "vertical",
        legend.title = element_text(face = "bold"),
        legend.text = element_markdown()) +
  scale_fill_manual(values = palette_cluster, labels = legend_cluster, name = "Cluster and interpretation")

  # 2.2 Save the map --

  ggsave(filename = paste0("./../figs/03_map-cluster-", i,".png"), height = 4, width = 9, dpi = 600)

}

# 3. Remove useless objects ----

rm(data_var, data_hcpc_descriptors, data_hcpc_cluster, i, legend_cluster, plot_var, plot_ind, plot_ind_col, annotation_label)

```

## Figure 5

```{r}

# 1. Filter and transform the data ----

data_method <- data_gcrmn %>% 
  # Add missing method (obtained from literature) for CURA1
  mutate(Method = ifelse(DatasetID == "CURA1" & Year == 1983, "Photo-quadrat", Method)) %>% 
  select(Latitude, Longitude, Year, Method) %>% 
  distinct(.) %>% 
  mutate(Method = str_split_fixed(Method, ",", 6)[,1],
         Method = str_to_lower(Method),
         Method = str_trim(Method, side = "both"),
         Method = str_squish(Method),
         Method = case_when(Method %in% c("line intercept transect", 
                                          "line intersect transect",
                                          "lit") ~ "LIT",
                            Method %in% c("point intercept method",
                                          "point intercept transect",
                                          "point intersect transect",
                                          "pit") ~ "PIT",
                            Method %in% c("photo-quadrat",
                                          "Photo-quadrat",
                                          "photoquadrats along 50m transects",
                                          "underwater photo transect") ~ "Photo-quadrat",
                            Method %in% c("visual census",
                                          "visual quadrat estimation",
                                          "vis est.") ~ "Visual census",
                            Method == "video-transect" ~ "Video transect",
                            TRUE ~ "Unknown")) %>% 
  mutate(Method = fct_relevel(Method, c("Unknown", "Photo-quadrat", "PIT", "LIT", "Video transect", "Visual census"))) %>% 
  group_by(Method, Year) %>% 
  count(name = "Abs") %>% 
  ungroup() %>% 
  complete(Method, fill = list(Abs = 0)) %>% 
  group_by(Year) %>% 
  mutate(Rel = (Abs/sum(Abs))*100)

# 2. Define label positions ----

data_method_label <- tibble(Method = c("Unknown", "Photo-quadrat", "PIT", "LIT", "Video transect", "Visual census"),
                            x = c(1997, 2012, 2003, 1989, 2001, 1988),
                            y = c(0.95, 0.75, 0.5, 0.65, 0.22, 0.20),
                            group = c(1, 2, 2, 2, 2, 1)) # Group 1 = text white, group 2 = text black

# 3. Make the plot ----

ggplot(data = data_method, aes(x = Year, y = Rel, fill = Method, label = Method)) +
  geom_stream(type = "proportional", show.legend = FALSE, alpha = 0.9) +
  geom_text(data = data_method_label %>% filter(group == 2), 
            aes(x = x, y = y, label = Method), family = font_choose_graph) +
  geom_text(data = data_method_label %>% filter(group == 1), 
            aes(x = x, y = y, label = Method), col = "white", family = font_choose_graph) +
  scale_fill_brewer(palette = "RdYlBu") +
  lims(x = c(1979, 2020)) +
  labs(y = "Percentage of surveys", x = "Year") +
  scale_y_continuous(labels = scales::percent)

# 4. Save the plot ----

ggsave(filename = "../figs/01_figure-5.png", height = 4, width = 8, dpi = 600)

# 5. Export tables to include numbers in the manuscript ----

write.csv2(data_method, file = "../figs/03_methods-by-year.csv", row.names = FALSE)

# 6. Remove useless objects ----

rm(data_method, data_method_label)

```

## Figure 6

```{r}

# 1. Filter and transform the data ----

data_source <- data_gcrmn %>% 
  select(Latitude, Longitude, Year, Source) %>% 
  distinct(.) %>%
  group_by(Source, Year) %>% 
  count(name = "Abs") %>% 
  ungroup() %>% 
  complete(Source, fill = list(Abs = 0)) %>% 
  group_by(Year) %>% 
  mutate(Rel = (Abs/sum(Abs))*100,
         Source = fct_relevel(Source, c("Unknown", "Government", "Non-tourism private sector", "NGO", 
                                       "Tourism", "Research institute and university")))

# 2. Define label positions ----

data_source_label <- tibble(Source = c("Unknown", "Government", "Non-tourism private sector", "NGO", 
                                       "Tourism", "Research institute and university"),
                            x = c(1995.5, 2012, 2006, 2003, 2012.5, 2005),
                            y = c(0.90, 0.775, 0.46, 0.3, 0.21, 0.075),
                            group = c(2, 2, 2, 2, 2, 1)) # Group 1 = text white, group 2 = text black

# 3. Make the plot ----

ggplot(data = data_source, aes(x = Year, y = Rel, fill = Source, label = Source)) +
  geom_stream(type = "proportional", show.legend = FALSE, alpha = 0.9) +
  geom_text(data = data_source_label %>% filter(group == 2), 
            aes(x = x, y = y, label = Source), family = font_choose_graph) +
  geom_text(data = data_source_label %>% filter(group == 1), 
            aes(x = x, y = y, label = Source), col = "white", family = font_choose_graph) +
  scale_fill_brewer(palette = "RdYlBu") +
  lims(x = c(1980, 2020)) +
  labs(y = "Percentage of surveys", x = "Year") +
  scale_y_continuous(labels = scales::percent) +
  # Arrow for "Unknown"
  annotate("segment", x = 1998, xend = 2000, y = 0.90, yend = 0.98, col = "black") +
  # Arrow for "Non-tourism private sector"
  annotate("segment", x = 2009, xend = 2010, y = 0.49, yend = 0.54, col = "black") +
  # Arrow for "Tourism"
  annotate("segment", x = 2017, xend = 2015, y = 0.16, yend = 0.185, col = "black")

# 4. Save the plot ----

ggsave(filename = "../figs/01_figure-6.png", height = 4, width = 8, dpi = 600)

# 5. Remove useless objects ----

rm(data_source, data_source_label)

```

# Supplementary

## Regional maps

```{r}

# 1. Transform CRS for data map ----

data_map <- data_map %>% 
  st_transform(., crs = 4326)

# 2. Transform CRS for data GCRMN sites ----

data_gcrmn_sites <- data_gcrmn_sites %>% 
  st_transform(., crs = 4326)

# 3. Transform CRS for data MEOW reefs ----

data_meowreefs <- data_meowreefs %>% 
  st_transform(., crs = 4326)

```

### Australia

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(133, -25))), crs = 4326) %>%
  st_buffer(dist = 28)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(141, 140, 142, 150, 143, 202, 203, 204, 205, 206, 207, 208, 209, 211, 210, 145, 144))

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, data_gcrmn_sites)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  scale_color_manual(values = palette_5cols) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "Australia")
 
# 6. Save the map ----

ggsave("../figs/03_regional-map-australia.png", dpi = 600, width = 4, height = 5)

```

### Caribbean

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(-85, 18))), crs = 4326) %>%
  st_buffer(dist = 35)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(69, 43, 70, 63, 65, 64, 66, 67, 62, 59, 60, 61, 164, 165, 166, 167,
                           168, 169, 170, 171, 172, 173, 174, 175, 68, 42))

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, data_gcrmn_sites)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  scale_color_manual(values = palette_5cols) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "Caribbean and Eastern Pacific")
 
# 6. Save the map ----

ggsave("../figs/03_regional-map-caribbean.png", dpi = 600, width = 4, height = 5)

```

### Red Sea and Gulf

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(47, 20))), crs = 4326) %>%
  st_buffer(dist = 20)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(87, 88, 89, 90, 91, 92))

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, data_gcrmn_sites)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  scale_color_manual(values = palette_5cols) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "Red Sea and Gulf")
 
# 6. Save the map ----

ggsave("../figs/03_regional-map-red-sea-and-gulf.png", dpi = 600, width = 4, height = 5)

```

### Western Indian Ocean

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(50, -12))), crs = 4326) %>%
  st_buffer(dist = 27)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 193))

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, data_gcrmn_sites)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  scale_color_manual(values = palette_5cols) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "Western Indian Ocean")
 
# 6. Save the map ----

ggsave("../figs/03_regional-map-wio.png", dpi = 600, width = 4, height = 5)

```

### Brazil

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(-35, -12))), crs = 4326) %>%
  st_buffer(dist = 18)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(73, 74, 75, 76, 77, 180))

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, data_gcrmn_sites)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  scale_color_manual(values = palette_5cols) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "Brazil")
 
# 6. Save the map ----

ggsave("../figs/03_regional-map-brazil.png", dpi = 600, width = 4, height = 5)

```

### South Asia

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(77, 10))), crs = 4326) %>%
  st_buffer(dist = 25)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(103, 104, 105, 106, 107))

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, data_gcrmn_sites)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  scale_color_manual(values = palette_5cols) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "South Asia")
 
# 6. Save the map ----

ggsave("../figs/03_regional-map-south-asia.png", dpi = 600, width = 4, height = 5)

```

### East Asia

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(125, 4))), crs = 4326) %>%
  st_buffer(dist = 40)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(109, 110, 111, 118, 115, 116, 114, 112, 113, 117, 119, 120, 127, 133, 126,
                           128, 129, 130, 131, 139, 138, 134, 136, 137, 132, 125, 121, 47, 48, 49, 50, 51, 52))

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, data_gcrmn_sites)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  scale_color_manual(values = palette_5cols) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "East Asia")
 
# 6. Save the map ----

ggsave("../figs/03_regional-map-east-asia.png", dpi = 600, width = 4, height = 5)

```

### Pacific

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(171.5, 10))), crs = 4326) %>%
  st_buffer(dist = 42)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

data_map_region <- st_shift_longitude(data_map_region)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(124, 135, 149, 148, 122, 123, 153, 154, 147, 157, 146, 156, 155, 152))

data_meowreefs_region <- st_shift_longitude(data_meowreefs_region)

data_meowreefs_region <- data_meowreefs_region %<>% # Special pipe from magrittr
  st_buffer(0.0015) # To join polygon (remove vertical line)

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, st_shift_longitude(data_gcrmn_sites))

data_sites_region <- st_shift_longitude(data_sites_region)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  scale_color_manual(values = palette_5cols) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "Pacific")
 
# 6. Save the map ----

ggsave("../figs/03_regional-map-pacific.png", dpi = 600, width = 4, height = 5)

```

## Maps of descriptors

### Reef area by ecoregion

```{r}

# 1. Create bins ----

hist(data_descriptors$area_rel)

data_descriptors_maps <- data_descriptors %>% 
  mutate(area_rel_cut = cut(area_rel, breaks = c(0, 0.25, 2, 4, 10), include.lowest = TRUE))

# 2. Make the map ----

ggplot() +
  # MEOW
  geom_sf(data = data_descriptors_maps, aes(fill = area_rel_cut)) +
  # Background map
  geom_sf(data = data_map_160) +
  coord_sf(ylim = c(-5000000, 5000000), expand = FALSE) +
  scale_fill_manual(values = c("#d73027", "#fc8d59", "#91bfdb", "#2c7bb6")) +
  guides(fill = guide_legend(title.position = "top",
                             title.hjust = 0.5,
                             title = "Relative coral reef area (%)")) +
  theme_map()

# 3. Save the map ----

ggsave(file = "../figs/03_map-descriptor-reef-area.png", height = 3, width = 9, dpi = 600)

```

### Main stakeholder

```{r}

# 1. Create bins ----

data_source <- data_gcrmn_meow %>% 
  select(Latitude, Longitude, Year, Source, ECOREGION) %>% 
  distinct(.) %>% 
  group_by(Source, ECOREGION) %>% 
  count(name = "Abs") %>% 
  ungroup() %>% 
  group_by(ECOREGION) %>% 
  filter(Abs == max(Abs)) %>% 
  select(-Abs) %>% 
  left_join(data_meowreefs, .) %>% 
  select(ECOREGION, Source) %>% 
  mutate(Source = replace_na(Source, "Unknown")) %>% 
  st_transform(crs = crs_selected)

# 2. Make the map ----

map_source <- ggplot() +
  # MEOW
  geom_sf(data = data_source, aes(fill = Source)) +
  # Background map
  geom_sf(data = data_map_160) +
  coord_sf(ylim = c(-5000000, 5000000), expand = FALSE) +
  scale_fill_manual(values = c("#2c7bb6", "#fc8d59",  "#f7ca18", "white")) +
  guides(fill = guide_legend(title.position = "top",
                             title.hjust = 0.5, nrow = 2,
                             title = "Main stakeholder")) +
  theme_map()

# 3. Save the map ----

ggsave(map_source, file = "../figs/03_map-descriptor-source.png", height = 3, width = 9, dpi = 600)

```

### Pixel with data

```{r}

# 1. Create bins ----

hist(data_descriptors$area_rel)

data_descriptors_maps <- data_descriptors %>% 
  mutate(percent_n_cut = cut(n_percent, breaks = c(0, 25, 50, 75, 100), include.lowest = TRUE),
         percent_n_cut = ifelse(n_percent == 0, "No data", as.character(percent_n_cut)),
         percent_n_cut = factor(percent_n_cut, levels = c("No data", "[0,25]", "(25,50]", "(50,75]", "(75,100]")))

# 2. Make the map ----

map_pixel <- ggplot() +
  # MEOW
  geom_sf(data = data_descriptors_maps, aes(fill = percent_n_cut)) +
  # Background map
  geom_sf(data = data_map_160) +
  coord_sf(ylim = c(-5000000, 5000000), expand = FALSE) +
  scale_fill_manual(values = c("white", "#fc8d59", "#f7ca18", "#91bfdb", "#2c7bb6")) +
  guides(fill = guide_legend(title.position = "top",
                             title.hjust = 0.5,
                             title = "Percentage of pixel with data")) +
  theme_map()

# 3. Save the map ----

ggsave(map_pixel, file = "../figs/03_map-descriptor-pixel.png", height = 3, width = 9, dpi = 600)

```

### First year

```{r}

# 1. Create bins ----

hist(data_descriptors$first_year)

data_descriptors_maps <- data_descriptors %>% 
  mutate(first_year_cut = case_when(is.na(first_year) ~ "No data",
                                    first_year >= 1980 & first_year < 2000 ~ "1980 - 1999",
                                    first_year >= 2000 & first_year < 2010 ~ "2000 - 2009",
                                    first_year >= 2010 ~ "> 2010"),
                    first_year_cut = factor(first_year_cut, 
                                            levels = c("1980 - 1999", "2000 - 2009", "> 2010", "No data")))

# 2. Make the map ----

map_first <- ggplot() +
  # MEOW
  geom_sf(data = data_descriptors_maps, aes(fill = first_year_cut)) +
  # Background map
  geom_sf(data = data_map_160) +
  coord_sf(ylim = c(-5000000, 5000000), expand = FALSE) +
  scale_fill_manual(values = c("#2c7bb6",  "#91bfdb", "#fc8d59", "white")) +
  guides(fill = guide_legend(title.position = "top",
                             title.hjust = 0.5,
                             title = "Year with first monitoring")) +
  theme_map()

# 3. Save the map ----

ggsave(map_first, file = "../figs/03_map-descriptor-first-year.png", height = 3, width = 9, dpi = 600)

```

### Years with data

```{r}

# 1. Create bins ----

hist(data_descriptors$n_years_abs)

data_descriptors_maps <- data_descriptors %>% 
    mutate(n_years_abs_cut = case_when(n_years_abs == 0 ~ "No data",
                                       n_years_abs > 0 & n_years_abs <= 10 ~ "1 - 10",
                                       n_years_abs > 10 & n_years_abs <= 20 ~ "11 - 20",
                                       n_years_abs > 20 ~ "> 21"),
           n_years_abs_cut = factor(n_years_abs_cut, levels = c("No data", "1 - 10", "11 - 20", "> 21")))

# 2. Make the map ----

map_years <- ggplot() +
  # MEOW
  geom_sf(data = data_descriptors_maps, aes(fill = n_years_abs_cut)) +
  # Background map
  geom_sf(data = data_map_160) +
  coord_sf(ylim = c(-5000000, 5000000), expand = FALSE) +
  scale_fill_manual(values = c("white", "#fc8d59", "#f7ca18", "#2c7bb6")) +
  guides(fill = guide_legend(title.position = "top",
                             title.hjust = 0.5,
                             title = "Number of years with data over 1980 - 2020")) +
  theme_map()

# 3. Save the map ----

ggsave(map_years, file = "../figs/03_map-descriptor-years.png", height = 3, width = 9, dpi = 600)

```

### Surveys

```{r}

# 1. Create bins ----

hist(data_descriptors$n_surveys_rel)

data_descriptors_maps <- data_descriptors %>% 
    mutate(n_surveys_rel_cut = case_when(n_surveys_rel == 0 ~ "No data",
                                         n_surveys_rel > 0 & n_surveys_rel <= 0.5 ~ "(0,0.5]",
                                         n_surveys_rel > 0.5 & n_surveys_rel <= 1 ~ "(0.5,1]",
                                         n_surveys_rel > 1 ~ "> 1"),
           n_surveys_rel_cut = factor(n_surveys_rel_cut, levels = c("No data", "(0,0.5]", "(0.5,1]", "> 1")))

# 2. Make the map ----

map_surveys <- ggplot() +
  # MEOW
  geom_sf(data = data_descriptors_maps, aes(fill = n_surveys_rel_cut)) +
  # Background map
  geom_sf(data = data_map_160) +
  coord_sf(ylim = c(-5000000, 5000000), expand = FALSE) +
  scale_fill_manual(values = c("white", "#fc8d59", "#f7ca18", "#2c7bb6")) +
  guides(fill = guide_legend(title.position = "top",
                             title.hjust = 0.5,
                             title = "Relative number of surveys (%)")) +
  theme_map()

# 3. Save the map ----

ggsave(map_surveys, file = "../figs/03_map-descriptor-surveys.png", height = 3, width = 9, dpi = 600)

```

### Methods

```{r}

# 1. Create bins ----

data_descriptors_maps <- data_gcrmn_meow %>% 
   # Add missing method (obtained from literature) for CURA1
  mutate(Method = ifelse(DatasetID == "CURA1" & Year == 1983, "Photo-quadrat", Method)) %>% 
  select(Latitude, Longitude, Year, Method, ECOREGION) %>% 
  distinct(.) %>% 
  mutate(Method = str_split_fixed(Method, ",", 6)[,1],
         Method = str_to_lower(Method),
         Method = str_trim(Method, side = "both"),
         Method = str_squish(Method),
         Method = case_when(Method %in% c("line intercept transect", 
                                          "line intersect transect",
                                          "lit") ~ "LIT",
                            Method %in% c("point intercept method",
                                          "point intercept transect",
                                          "point intersect transect",
                                          "pit") ~ "PIT",
                            Method %in% c("photo-quadrat",
                                          "Photo-quadrat",
                                          "photoquadrats along 50m transects",
                                          "underwater photo transect") ~ "Photo-quadrat",
                            Method %in% c("visual census",
                                          "visual quadrat estimation",
                                          "vis est.") ~ "Visual census",
                            Method == "video-transect" ~ "Video transect",
                            TRUE ~ "Unknown")) %>%
  left_join(data_meowreefs, .) %>% 
  mutate(Method = replace_na(Method, "No data"),
         Method = as.factor(Method),
         Method = fct_relevel(Method, c("No data", "Unknown", "Photo-quadrat", "Video transect", 
                                        "PIT", "LIT", "Visual census"))) %>% 
  group_by(Method, ECOREGION) %>% 
  count(name = "Abs") %>% 
  ungroup() %>% 
  group_by(ECOREGION) %>% 
  filter(Abs == max(Abs)) %>% 
  select(-Abs) %>% 
  st_as_sf() %>% 
  st_transform(crs = crs_selected)

# 2. Make the map ----

map_methods <- ggplot() +
  # MEOW
  geom_sf(data = data_descriptors_maps, aes(fill = Method)) +
  # Background map
  geom_sf(data = data_map_160) +
  coord_sf(ylim = c(-5000000, 5000000), expand = FALSE) +
  scale_fill_manual(values = c("#ecf0f1", "#d73027", "#fc8d59", "#f7ca18", "#91bfdb", "#2c7bb6", "#ffec8b")) +
  guides(fill = guide_legend(title.position = "top",
                             title.hjust = 0.5,
                             title = "Most used method")) +
  theme_map()

# 3. Save the map ----

ggsave(map_methods, file = "../figs/03_map-descriptor-methods.png", height = 3, width = 8, dpi = 600)

```

### Bind plots

```{r fig.height=12, fig.width=10}

# 1. Make the map ----

plot_grid(map_methods, map_source, map_pixel, map_surveys, map_first, map_years, map_methods, 
          nrow = 3, ncol = 2, labels = c("A", "B", "C", "D", "E", "F"))

# 2. Save the map ----

ggsave(file = "../figs/02_supplementary-3.png", height = 8, width = 10)

```

## Distribution of descriptors values

```{r fig.height=12, fig.width=8}

# 1. Reformat descriptors ----

data_descriptors_clust <- data_ind %>% 
  st_drop_geometry() %>% 
  select(-"Dim.1", -"Dim.2") %>% 
  left_join(., data_descriptors_pca) %>%
  mutate(y = 1) %>% 
  filter(clust != "4")

# 2. Loop to make a plot for each variable (each descriptor) ----

# 2.1 Defined the variables to plot --

i_colnames <- names(data_descriptors_clust)[4:9]

# 2.2 Create an empty list to store the plots --

plot_list <- list()

# 2.3 Create x axis titles -- 

plot_title <- tibble(raw = i_colnames,
                     title = c("Number of monitoring sites (<i>n_sites</i>)",
                               "Number of surveys (<i>n_surveys</i>)",
                               "First year with monitoring data (<i>first_year</i>)",
                               "Number of long-term (> 15 years) monitoring sites (<i>n_ltms</i>)",
                               "Number of years with monitoring data (<i>n_years</i>)",
                               "Percentage of pixels with monitoring data (<i>pixel_data</i>)"))

# 2.4 Run the loop --

for(i in i_colnames){

  # Define position to use geom_jitter and geom_text_repel simultaneously
  pos <- position_jitter(width = 0.3, seed = 2)

  plot_i <- ggplot(data = data_descriptors_clust, aes_string(x = i, y = "y", label = "ECO_CODE_X")) +
    geom_violin(fill = "lightgrey", alpha = 0.25, col = "darkgray") +
    geom_vline(xintercept = mean(data_descriptors_clust %>% select(i) %>% pull(), na.rm = TRUE), color = "black") +
    geom_jitter(shape = 21, size = 4, aes(fill = clust), position = pos) +
    scale_fill_manual(values = palette_cluster[1:3], name = "Cluster") +
    geom_text_repel(show.legend = FALSE, size = 2.5, seed = 20, max.overlaps = 5, family = font_choose_graph, position = pos) +
    theme(axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          legend.position = "top",
          legend.key = element_blank(),
          axis.title.x = element_markdown(size = 13)) +
    labs(x = plot_title %>% filter(raw == i) %>% select(title) %>% pull()) +
    guides(fill = guide_legend(title.position = "top", title.hjust = 0.5, override.aes = list(size = 5)))

  plot_list[[i]] <- plot_i 

}

# 3. Combine plots ----

# 3.1 Extract the legend from one of the plots --

common_legend <- get_legend(plot_list[["n_sites_abs"]])

# 3.2 Combine plots --

plot_grid(common_legend, 
          plot_list[["n_sites_abs"]] + theme(legend.position = "none",
                                             plot.margin = unit(c(1,3,1,3), "lines")), 
          plot_list[["n_surveys_abs"]] + theme(legend.position = "none",
                                               plot.margin = unit(c(1,3,1,3), "lines")),
          plot_list[["first_year"]] + theme(legend.position = "none",
                                            plot.margin = unit(c(1,3,1,3), "lines")), 
          plot_list[["n_15_abs"]] + theme(legend.position = "none",
                                          plot.margin = unit(c(1,3,1,3), "lines")), 
          plot_list[["n_years_abs"]] + theme(legend.position = "none",
                                             plot.margin = unit(c(1,3,1,3), "lines")), 
          plot_list[["n_percent"]] + theme(legend.position = "none",
                                           plot.margin = unit(c(1,3,1,3), "lines")), 
          ncol = 1)

# 4. Save the plot ----

ggsave(filename = "../figs/02_supplementary-4.png", dpi = 600, width = 8, height = 12)

```

## Table of descriptors

```{r}

data_descriptors %>% 
  select(ECO_CODE_X, ECOREGION, area_abs, area_rel, n_1_abs, n_2_5_abs, n_6_10_abs, 
         n_11_15_abs, n_15_abs, n_surveys_abs, n_years_abs, first_year, n_percent) %>%
  rename(Code = ECO_CODE_X, Name = ECOREGION, Surveys = n_surveys_abs) %>% 
  st_drop_geometry() %>% 
  mutate(area_abs = round(area_abs*1e-6, 1),
         area_rel = round(area_rel, 3),
         n_percent = round(n_percent, 1)) %>%
  # Join with data_ind to add the cluster of each ecoregion
  left_join(., data_ind %>% 
              st_drop_geometry() %>% 
              select(ECO_CODE_X, clust) %>% 
              rename(Code = ECO_CODE_X, Cluster = clust)) %>% 
  write.csv2(., file = "../figs/02_table-of-descriptors.csv", row.names = FALSE)

```

# Additional figures

## Lollipop plot

```{r fig.height=15, fig.width=10}

# 1. Transform the data ----

data_descriptors <- data_descriptors %>% 
  mutate(color = "#446cb3",
         name = glue("{ECOREGION} (<b style='color:{color}'>{ECO_CODE_X}</b>)"))

# 2. Make the plots ----

# 2.1 Relative coral reefs surface by ecoregion --

plot_area <- ggplot(data = data_descriptors, aes(x = fct_reorder(name, area_rel), y = area_rel)) +
  geom_point() +
  geom_segment(aes(xend = fct_reorder(name, area_rel), y = 0, yend = area_rel)) +
  coord_flip() +
  theme(axis.text.y = element_markdown()) +
  labs(x = NULL, y ="Area (%)")

# 2.2 Number of surveys by ecoregion --

plot_surveys <- ggplot(data = data_descriptors, aes(x = fct_reorder(name, area_rel), y = n_surveys_rel)) +
  geom_point() +
  geom_segment(aes(xend = fct_reorder(name, area_rel), y = 0, yend = n_surveys_rel)) +
  coord_flip() +
  theme(axis.text.y = element_markdown()) +
  labs(x = NULL, y = "Surveys (%)") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

# 2.3 Number of years with data by ecoregion --

plot_years <- ggplot(data = data_descriptors, aes(x = fct_reorder(name, area_rel), y = n_years_abs)) +
  geom_point() +
  geom_segment(aes(xend = fct_reorder(name, area_rel), y = 0, yend = n_years_abs)) +
  coord_flip() +
  theme(axis.text.y = element_markdown()) +
  labs(x = NULL, y = "Years (n)") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

# 2.4 Number of pixel with data by ecoregion --

plot_pixel <- ggplot(data = data_descriptors, aes(x = fct_reorder(name, area_rel), y = n_percent)) +
  geom_point() +
  geom_segment(aes(xend = fct_reorder(name, area_rel), y = 0, yend = n_percent)) +
  coord_flip() +
  theme(axis.text.y = element_markdown()) +
  labs(x = NULL, y = "Pixel (%)") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

# 3. Assemble the plots ----

plot_grid(plot_area, plot_surveys, plot_years, plot_pixel, nrow = 1, rel_widths = c(1, 0.35, 0.35, 0.35))

# 4. Save the plot ----

ggsave(filename = "../figs/03_lollipop-ecoregions-data-descriptors.png", height = 15, width = 14, dpi = 600)

# 5. Remove useless objects ----

rm(plot_area, plot_surveys, plot_years, plot_pixel)

```

## Datasets by year

```{r}

# 1. Transform the data ----

data_datasets <- data_gcrmn %>% 
  select(DatasetID, Year) %>% 
  distinct() %>% 
  group_by(Year) %>% 
  count()

# 2. Make the plot ----

ggplot(data = data_datasets, aes(x = Year, y = n)) +
  geom_bar(stat = "identity") +
  theme_graph() +
  labs(y = "Number of datasets")

# 3. Save the plot ----

ggsave(filename = "../figs/03_number-datasets-by-year.png", dpi = 600, width = 6, height = 4)

```

## Datasets contribution

```{r}

# 1. Transform the data ----

surveys_dataset <- data_gcrmn  %>% 
  select(Latitude, Longitude, Year, Date, DatasetID) %>% 
  distinct(.) %>% 
  group_by(DatasetID) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(percent_surveys = (n/sum(n))*100) %>% 
  arrange(desc(percent_surveys))

# 2. Make the plot (only for first 20 datasets) ----

ggplot(data = surveys_dataset %>% slice(1:20), aes(x = reorder(DatasetID, desc(percent_surveys)), y = percent_surveys)) +
  geom_bar(stat = "identity", fill = col_color_map) +
  labs(x = NULL, y = "Percentage of surveys") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.75, hjust = 0.75))

# 3. Save the plot ----

ggsave(filename = "../figs/03_percentage-surveys-by-dataset.png", dpi = 600, width = 6, height = 4)

# 4. Export the data ----

write.csv2(surveys_dataset, file = "../figs/03_table-percentage-surveys-by-dataset.csv", row.names = FALSE)

```   

## Number of benthic categories per survey

```{r}

# 1. Transform the data ----

surveys_dataset <- data_gcrmn  %>% 
  select(Latitude, Longitude, Year, Date, DatasetID, Category, Group, Family, Genus, Species) %>% 
  distinct(.) %>% 
  group_by(Latitude, Longitude, Year, Date, DatasetID) %>% 
  count() %>% 
  ungroup()

# 2. Make the plot ----

ggplot(data = surveys_dataset, aes(x = n)) +
  geom_histogram(fill = col_color_map) +
  labs(x = "Number of benthic categories", y = "Number of surveys")

# 3. Save the plot ----

ggsave(filename = "../figs/03_number-categories-per-surveys.png", dpi = 600, width = 6, height = 4)

```

# Reproducibility

```{r reprod}

# 1. Reproducibility ----

sessionInfo()

```

---
Jeremy WICQUART | jeremywicquart@gmail.com | `r format(Sys.time())`