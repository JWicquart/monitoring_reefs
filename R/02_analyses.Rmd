---
title: "Analyses"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: "cosmo"
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Load packages and data

```{r}

# 1. Load packages ----

library(magrittr) # To use special pipes
library(tidyverse) # Core tidyverse packages
library(sf)
sf_use_s2(FALSE) # Switch from S2 to GEOS
library(ggstream)
library(cowplot)
library(ggsflabel)
library(ggtext)
library(glue)

# 2. Source functions ----

source("functions/graphical_par.R")
source("functions/theme_map.R")
source("functions/theme_graph.R")
theme_set(theme_graph())

# 3. Load MEOW data ----

load(file = "../data/04_meow-with-coral-reefs.RData")

# 4. Load 2020 GCRMN data ----

data_gcrmn <- read.csv2(file = "../data/03-merge_all_all_all_benthos_NA.csv") %>% 
  filter(!(DatasetID %in% c("XLCA1", "XLCA2", "XLCA3", "XLCA4", "XLCA5"))) %>% 
  drop_na(Latitude, Longitude)

# 5. Remove sites falling outside MEOW containing coral reefs ----

data_gcrmn <- data_gcrmn %>% 
  mutate(lat = Latitude, 
         long = Longitude) %>% 
  st_as_sf(., coords = c("long", "lat"), crs = 4326) %>% 
  st_join(., data_meowreefs) %>% 
  drop_na(ECOREGION) %>% 
  st_drop_geometry() %>% 
  select(-ECOREGION:-SHAPE_Area)

# 6. Summarize by duration ----

data_gcrmn_sites <- data_gcrmn %>% 
  group_by(Area, Country, Location, Site, Latitude, Longitude) %>% 
  drop_na(Year) %>% 
  summarise(interval_years = max(Year, na.rm = TRUE) - min(Year, na.rm = TRUE)) %>%
  ungroup() %>% 
  mutate(interval_class = cut(interval_years, 
                              breaks = c(-Inf, 1, 5, 10, 15, Inf),
                              labels = c("1", "2-5", "6-10", "11-15", ">15"))) %>% 
  st_as_sf(., coords = c("Longitude", "Latitude"), crs = 4326) %>% 
  st_transform(., crs = crs_selected)

```

# 2. Maps

## 2.1 Load data

```{r}

# 1. Load background maps ----

data_map <- read_sf("../data/00_natural-earth-data/ne_10m_land/ne_10m_land.shp") %>% 
  st_transform(crs = 4326) %>% 
  st_transform(crs = crs_selected)

# 2. Create the border of background map ----

lats <- c(90:-90, -90:90, 90)
longs <- c(rep(c(180, -180), each = 181), 180)

background_map_border <- list(cbind(longs, lats)) %>%
  st_polygon() %>%
  st_sfc(crs = 4326) %>% 
  st_sf() %>%
  st_transform(crs = crs_selected)

# 3. Create polygons for tropics ----

data_tropics <- tibble(tropic = c("Equator", "Equator", "Cancer", "Cancer", "Capricorne", "Capricorne"),
                       lat = c(0, 0, 23.43667, 23.43667, -23.43667, -23.43667),
                       long = c(-180, 180, -180, 180, -180, 180)) %>% 
  st_as_sf(coords = c("long", "lat"), crs = 4326) %>% 
  group_by(tropic) %>% 
  summarize() %>%
  st_cast("LINESTRING") %>% 
  st_transform(crs = crs_selected)

```

## 2.2 Global map MEOW

```{r}

# 1. Make the map ----

ggplot() +
  # Background map border
  geom_sf(data = background_map_border, fill = "#56B4E950", color = "grey30", size = 0.5/.pt) +
  # MEOW
  geom_sf(data = data_meowreefs, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map, fill = col_fill_map, col = col_color_map) +
  guides(colour = guide_legend(override.aes = list(size = 5))) +
  scale_color_manual(values = palette_duration) +
  theme_map() +
  theme(legend.title = element_blank())

# 2. Save the map ----

ggsave("../figs/01_global-meow-with-coral-reefs.png", height = 6, width = 10)

```

## 2.3 Global map duration

```{r}

# 1. Make the map ----

ggplot() +
  # Background map border
  geom_sf(data = background_map_border, fill = "#56B4E950", color = "grey30", size = 0.5/.pt) +
  # MEOW
  geom_sf(data = data_meowreefs, fill = "#ecf0f1") +
  # Site of benthic cover data
  geom_sf(data = data_gcrmn_sites, aes(color = interval_class)) +
  # Background map
  geom_sf(data = data_map, fill = col_fill_map, col = col_color_map) +
  guides(colour = guide_legend(title.position = "top", title.hjust = 0.5, override.aes = list(size = 5))) +
  scale_color_manual(values = palette_duration) +
  theme_map() +
  labs(col = "Monitoring duration (years)")

# 2. Save the map ----

ggsave("../figs/01_global-map-site-duration.png", height = 6, width = 10)

```

## 2.4 Regional maps duration

```{r}

# 1. Transform CRS for data map ----

data_map <- data_map %>% 
  st_transform(., crs = 4326)

# 2. Transform CRS for data GCRMN sites ----

data_gcrmn_sites <- data_gcrmn_sites %>% 
  st_transform(., crs = 4326)

```

### Australia

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(133, -25))), crs = 4326) %>%
  st_buffer(dist = 28)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(141, 140, 142, 150, 143, 202, 203, 204, 205, 206, 207, 208, 209, 211, 210, 145, 144))

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, data_gcrmn_sites)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  #geom_sf_text_repel(data = data_meowreefs_region, aes(label = ECO_CODE_X), size = 2, family = font_choose_map) +
  scale_color_manual(values = palette_duration) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "Australia")
 
# 6. Save the map ----

ggsave("../figs/06_meow-australia.png", dpi = 600, width = 4, height = 5)

```

### Caribbean

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(-85, 18))), crs = 4326) %>%
  st_buffer(dist = 35)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(69, 43, 70, 63, 65, 64, 66, 67, 62, 59, 60, 61, 164, 165, 166, 167,
                           168, 169, 170, 171, 172, 173, 174, 175, 68, 42))

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, data_gcrmn_sites)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  #geom_sf_text_repel(data = data_meowreefs_region, aes(label = ECO_CODE_X), size = 2, family = font_choose_map) +
  scale_color_manual(values = palette_duration) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "Caribbean and Eastern Pacific")
 
# 6. Save the map ----

ggsave("../figs/06_meow-caribbean-and-eastern-pacific.png", dpi = 600, width = 4, height = 5)

```

### Red Sea and Gulf

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(47, 20))), crs = 4326) %>%
  st_buffer(dist = 20)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(87, 88, 89, 90, 91, 92))

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, data_gcrmn_sites)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  #geom_sf_text_repel(data = data_meowreefs_region, aes(label = ECO_CODE_X), size = 2, family = font_choose_map) +
  scale_color_manual(values = palette_duration) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "Red Sea and Gulf")
 
# 6. Save the map ----

ggsave("../figs/06_meow-red-sea-and-gulf.png", dpi = 600, width = 4, height = 5)

```

### Western Indian Ocean

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(50, -12))), crs = 4326) %>%
  st_buffer(dist = 27)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 193))

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, data_gcrmn_sites)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  #geom_sf_text_repel(data = data_meowreefs_region, aes(label = ECO_CODE_X), size = 2, family = font_choose_map) +
  scale_color_manual(values = palette_duration) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "Western Indian Ocean")
 
# 6. Save the map ----

ggsave("../figs/06_meow-western-indian-ocean.png", dpi = 600, width = 4, height = 5)

```

### Brazil

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(-35, -12))), crs = 4326) %>%
  st_buffer(dist = 18)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(73, 74, 75, 76, 77, 180))

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, data_gcrmn_sites)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  #geom_sf_text_repel(data = data_meowreefs_region, aes(label = ECO_CODE_X), size = 2, family = font_choose_map) +
  scale_color_manual(values = palette_duration) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "Brazil")
 
# 6. Save the map ----

ggsave("../figs/06_meow-brazil.png", dpi = 600, width = 4, height = 5)

```

### South Asia

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(77, 10))), crs = 4326) %>%
  st_buffer(dist = 25)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(103, 104, 105, 106, 107))

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, data_gcrmn_sites)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  #geom_sf_text_repel(data = data_meowreefs_region, aes(label = ECO_CODE_X), size = 2, family = font_choose_map) +
  scale_color_manual(values = palette_duration) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "South Asia")
 
# 6. Save the map ----

ggsave("../figs/06_meow-south-asia.png", dpi = 600, width = 4, height = 5)

```

### East Asia

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(125, 4))), crs = 4326) %>%
  st_buffer(dist = 40)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(109, 110, 111, 118, 115, 116, 114, 112, 113, 117, 119, 120, 127, 133, 126,
                           128, 129, 130, 131, 139, 138, 134, 136, 137, 132, 125, 121, 47, 48, 49, 50, 51, 52))

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, data_gcrmn_sites)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  #geom_sf_text_repel(data = data_meowreefs_region, aes(label = ECO_CODE_X), size = 2, family = font_choose_map) +
  scale_color_manual(values = palette_duration) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "East Asia")
 
# 6. Save the map ----

ggsave("../figs/06_meow-east-asia.png", dpi = 600, width = 4, height = 5)

```

### Pacific

```{r}

# 1. Create the buffer ----

data_buffer <- st_sf(coord = st_sfc(st_point(c(171.5, 10))), crs = 4326) %>%
  st_buffer(dist = 42)

# 2. Intersection based on buffer for data_map ----

data_map_region <- st_intersection(data_buffer, data_map)

data_map_region <- st_shift_longitude(data_map_region)

# 3. Select MEOW for the region ----

data_meowreefs_region <- data_meowreefs %>% 
  filter(ECO_CODE_X %in% c(124, 135, 149, 148, 122, 123, 153, 154, 147, 157, 146, 156, 155, 152))

data_meowreefs_region <- st_shift_longitude(data_meowreefs_region)

data_meowreefs_region <- data_meowreefs_region %<>% # Special pipe from magrittr
  st_buffer(0.0015) # To join polygon (remove vertical line)

# 4. Filter sites ----

data_sites_region <- st_intersection(data_meowreefs_region, st_shift_longitude(data_gcrmn_sites))

data_sites_region <- st_shift_longitude(data_sites_region)

# 5. Make the map ----

ggplot() +
  # First data buffer (for ocean color background)
  geom_sf(data = data_buffer, fill = col_background_map) +
  # MEOW
  geom_sf(data = data_meowreefs_region, fill = "#ecf0f1") +
  # Background map
  geom_sf(data = data_map_region, fill = col_fill_map, col = col_color_map) +
  # GCRMN sites
  geom_sf(data = data_sites_region, aes(color = interval_class), show.legend = FALSE) +
  #geom_sf_text_repel(data = data_meowreefs_region, aes(label = ECO_CODE_X), size = 2, family = font_choose_map) +
  scale_color_manual(values = palette_duration) +
  # Second data buffer (for borders)
  geom_sf(data = data_buffer, fill = NA, size = 0.75) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(title = "Pacific")
 
# 6. Save the map ----

ggsave("../figs/06_meow-pacific.png", dpi = 600, width = 4, height = 5)

```

# 3. Methods used

## 3.1 Temporal trend

```{r}

# 1. Filter and transform the data ----

data_method <- data_gcrmn %>% 
  filter(Year > 1980 & Year <= 2018) %>%   
  select(Latitude, Longitude, Year, Method) %>% 
  distinct(.) %>% 
  mutate(Method = str_split_fixed(Method, ",", 6)[,1],
         Method = str_to_lower(Method),
         Method = str_trim(Method, side = "both"),
         Method = str_squish(Method),
         Method = case_when(Method %in% c("line intercept transect", 
                                          "line intersect transect",
                                          "lit") ~ "LIT",
                            Method %in% c("point intercept method",
                                          "point intercept transect",
                                          "point intersect transect",
                                          "pit") ~ "PIT",
                            Method %in% c("photo-quadrat",
                                          "Photo-quadrat",
                                          "underwater photo transect") ~ "Photo-quadrat",
                            Method %in% c("visual census",
                                          "visual quadrat estimation",
                                          "vis est.") ~ "Visual census",
                            Method == "video-transect" ~ "Video transect",
                            TRUE ~ "Unknown")) %>% 
  mutate(Method = fct_relevel(Method, c("Unknown", "Photo-quadrat", "PIT", "LIT", "Video transect", "Visual census"))) %>% 
  group_by(Method, Year) %>% 
  count(name = "Abs") %>% 
  ungroup() %>% 
  complete(Method, fill = list(Abs = 0)) %>% 
  group_by(Year) %>% 
  mutate(Rel = (Abs/sum(Abs))*100)

# 2. Define label positions ----

data_method_label <- tibble(Method = c("Unknown", "Photo-quadrat", "PIT", "LIT", "Video transect", "Visual census"),
                            x = c(1995, 2012, 2003, 1989, 2001, 1990),
                            y = c(0.94, 0.75, 0.5, 0.65, 0.22, 0.22))

# 3. Make the plot ----

ggplot(data = data_method, aes(x = Year, y = Rel, fill = Method, label = Method)) +
  geom_stream(type = "proportional", show.legend = FALSE, alpha = 0.8) +
  geom_text(data = data_method_label, aes(x = x, y = y, label = Method), family = font_choose_graph) +
  # Alternative using geom_stream_label but less precise
  #geom_stream_label(type = "proportional", family = font_choose_graph) +
  scale_fill_manual(values = c("#dadfe1", "#FFC740", "#C20008", "#FF020D", "#13AFEF", "#2abb9b")) +
  lims(x = c(1980, 2020)) +
  labs(y = "Percentage of surveys", x = "Year")

# 4. Save the plot ----

ggsave(filename = "../figs/02_evolution-methods-used_streamplot.png", height = 4, width = 8)

# 5. Remove useless objects ----

rm(data_method, data_method_label)

```

# 4. Misc

## 4.1 Monitoring duration

```{r fig.width=6, fig.height=5}

# 1. Transform the data ----

data_duration <- data_gcrmn_sites %>% 
  st_drop_geometry() %>% 
  group_by(interval_class) %>% 
  summarise(n_abs = n()) %>% 
  ungroup() %>% 
  mutate(n_rel = (n_abs/sum(n_abs))*100)

# 2. Make the plot ----

plot_duration <- ggplot(data = data_duration, aes(x = interval_class, y = n_rel)) +
  geom_bar(stat = "identity", aes(fill = interval_class), show.legend = FALSE, col = "black") +
  scale_fill_manual(values = palette_duration) +
  lims(y = c(0, 100)) +
  labs(x = "Monitoring duration (years)", y = "Sites (%)")

```

## 4.2 Surveys by year

```{r}

# 1. Modify the data ----

data_year <- data_gcrmn %>% 
  select(Latitude, Longitude, Year) %>% 
  distinct(.)

# 2. Make the plot ----

plot_year <- ggplot(data_year, aes(x = Year)) +
  # By default its density, width*density*100 gives percentage
  geom_histogram(binwidth = 1, aes(y = stat(width*density*100)),
                 color = col_color_graph, fill = col_fill_graph) +
  lims(y = c(0, 10)) +
  labs(x = "Year", y = "Surveys (%)")

```

## 4.3 Surveys by depth

```{r}

# 1. Modify the data ----

data_depth <- data_gcrmn %>% 
  select(Latitude, Longitude, Year, Depth) %>% 
  distinct(.)

# 2. Make the plot ----

plot_depth <- ggplot(data = data_depth, aes(x = Depth)) +
  # By default its density, width*density*100 gives percentage
  geom_histogram(binwidth = 1, aes(y = stat(width*density*100)),
                 color = col_color_graph, fill = col_fill_graph) +
  lims(x = c(0, 40), y = c(0, 30)) +
  labs(x = "Depth (m)", y = "Surveys (%)")

```

## 4.4 plot assemblage

```{r}

# 1. Make the plot ----

plot_grid(plot_year, plot_depth, plot_duration, nrow = 1, labels = c("A", "B", "C"))

# 2. Save the plot ----

ggsave(filename = "../figs/03_combined-plots-distri-year-depth-duration.png", height = 3, width = 10)

# 3. Remove useless objects ----

rm(data_depth, plot_depth, data_year, plot_year, data_duration, plot_duration)

```

# 5. Taxonomic resolution

```{r}

# 1. Filter and transform the data ----

data_taxo <- data_gcrmn %>% 
  filter(Year > 1980 & Year <= 2018) %>%   
  select(Year, Category, Group, Family, Genus, Species) %>% 
  mutate(Tax_lvl = case_when(!(is.na(Species)) ~ "Species",
                             !(is.na(Genus)) ~ "Genus",
                             !(is.na(Family)) ~ "Family",
                             !(is.na(Group)) ~ "Group",
                             !(is.na(Category)) ~ "Category")) %>%
  mutate(Tax_lvl = fct_relevel(Tax_lvl, c("Category", "Group", "Family", "Genus", "Species"))) %>% 
  group_by(Year, Tax_lvl) %>% 
  count(name = "Abs") %>% 
  ungroup() %>% 
  complete(Tax_lvl, fill = list(Abs = 0)) %>% 
  group_by(Year) %>% 
  mutate(Rel = (Abs/sum(Abs))*100)

# 2. Define label positions ----

data_taxo_label <- tibble(Tax_lvl = c("Category", "Group", "Family", "Genus", "Species"),
                          x = c(1990, 2010, 1998, 2000, 2010),
                          y = c(0.875, 0.65, 0.4, 0.2, 0.1))

# 3. Make the plot ----

ggplot(data = data_taxo, aes(x = Year, y = Rel, fill = Tax_lvl, label = Tax_lvl)) +
  geom_stream(type = "proportional", show.legend = FALSE) +
  geom_text(data = data_taxo_label, aes(x = x, y = y, label = Tax_lvl), family = font_choose_graph) +
  # Alternative using geom_stream_label but less precise
  #geom_stream_label(type = "proportional", family = font_choose_graph) +
  scale_fill_manual(values = c("#FFC740", "#C20008", "#FF020D", "#13AFEF", "#2abb9b")) +
  lims(x = c(1980, 2020)) +
  labs(y = "Percentage of surveys", x = "Year")

# 4. Save the plot ----

ggsave(filename = "../figs/04_evolution-taxo-resolution_streamplot.png", height = 4, width = 8)

# 5. Remove useless objects ----

rm(data_taxo, data_taxo_label)

```

# 6. Comparison between ecoregions

## 6.1 Calculation of descriptors

```{r}

# 1. Load and transform Marine Ecoregions of the World (MEOW) data ----

data_meow <- read_sf("../data/02_marine-ecoregions-of-the-world/Marine_Ecoregions_Of_the_World__MEOW_.shp") %>% 
  st_transform(crs = 4326) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES")) %>% 
  st_make_valid()

# 2. Join MEOW and GCRMN data ----

data_gcrmn_meow <- data_gcrmn %>% 
  drop_na(Latitude, Longitude) %>% 
  st_as_sf(., coords = c("Longitude", "Latitude"), crs = 4326) %>% 
  st_intersection(., data_meow) %>% 
  mutate(geometry2 = str_remove_all(geometry, "c|\\(|\\)"),
         Longitude = as.numeric(str_split_fixed(geometry2, ",", 2)[,1]),
         Latitude = as.numeric(str_split_fixed(geometry2, ",", 2)[,2])) %>% 
  st_drop_geometry() %>% 
  select(-geometry2)

# 3. Calculation of sites ----

data_descriptors <- data_gcrmn_meow %>% 
  select(Latitude, Longitude, ECOREGION) %>% 
  distinct() %>% 
  group_by(ECOREGION) %>% 
  summarise(n_sites = n())

# 4. Calculation of observations ----

data_descriptors <- data_gcrmn_meow %>% 
  group_by(ECOREGION) %>% 
  summarise(n_obs = n()) %>% 
  left_join(data_descriptors, .)
  
# 5. Calculation of surveys ----

data_descriptors <- data_gcrmn_meow %>% 
  select(Latitude, Longitude, Year, ECOREGION) %>% 
  distinct() %>% 
  group_by(ECOREGION) %>% 
  summarise(n_surveys = n()) %>% 
  left_join(data_descriptors, .)

# 6. Calculation of monitoring duration ----

data_descriptors <- data_gcrmn_meow %>% 
  group_by(Area, Country, Location, Site, Latitude, Longitude, ECOREGION) %>% 
  summarise(interval_years = max(Year, na.rm = TRUE) - min(Year, na.rm = TRUE)) %>%
  drop_na(interval_years) %>% 
  ungroup() %>% 
  mutate(interval_class = cut(interval_years, 
                              breaks = c(-Inf, 1, 5, 10, 15, Inf),
                              labels = c("n_1", "n_2_5", "n_6_10", "n_11_15", "n_15"))) %>% 
  group_by(ECOREGION, interval_class) %>%
  summarise(n = n()) %>% 
  pivot_wider(names_from = interval_class, values_from = n, values_fill = 0) %>% 
  left_join(data_descriptors, .)

# 7. Number of years with data ---- 

data_descriptors <- data_gcrmn_meow %>% 
  select(ECOREGION, Year) %>% 
  distinct() %>% 
  group_by(ECOREGION) %>% 
  summarise(n_years = n(),
            first_year = min(Year)) %>% 
  left_join(data_descriptors, .)

# 8. Add reef surfaces ----

load("../data/04_reef-surface-by-ecoregion.RData")

data_descriptors <- left_join(data_descriptors, data_surface)

```

## 6.2 PCA

```{r}

library(FactoMineR)

PCA(data_descriptors[,2:12])

```

## 6.3 Effort vs surface

```{r}

# 1. Transform descriptors in relative ----

data_descriptors_rel <- data_descriptors %>% 
  mutate_at(2:ncol(.), ~ (./sum(., na.rm = TRUE))*100)

```

### Sites

```{r}

# 1. Make the plot ----

ggplot(data = data_descriptors_rel, aes(x = area, y = n_sites, label = ECOREGION)) +
  geom_point() +
  geom_label() +
  geom_abline(intercept = 0) +
  labs(x = "Relative reef surface (%)", y = "Relative sites number (%)")

# 2. Save the plot ----

ggsave(filename = "../figs/05_biplot-comparison-reef-surface-sites.png", height = 8, width = 8)

```

### Surveys

```{r}

# 1. Make the plot ----

ggplot(data = data_descriptors_rel, aes(x = area, y = n_surveys, label = ECOREGION)) +
  geom_point() +
  geom_label() +
  geom_abline(intercept = 0) +
  labs(x = "Relative reef surface (%)", y = "Relative surveys number (%)")

# 2. Save the plot ----

ggsave(filename = "../figs/05_biplot-comparison-reef-surface-surveys.png", height = 8, width = 8)

```

## 6.4 Maps

```{r}

# 1. Join MEOW with descriptors ----

data_meow <- read_sf("../data/02_marine-ecoregions-of-the-world/Marine_Ecoregions_Of_the_World__MEOW_.shp") %>% 
  st_transform(crs = 4326) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES")) %>% 
  st_make_valid() %>% 
  left_join(data_descriptors, .) %>% 
  st_as_sf()

# 2. Make the map ----

ggplot() +
  # Background map border
  geom_sf(data = background_map_border, fill = "#56B4E950", color = "grey30", size = 0.5/.pt) +
  # Site of benthic cover data
  geom_sf(data = data_meow, aes(fill = n_15)) +
  # Background map
  geom_sf(data = data_map, fill = col_fill_map, col = col_color_map) +
  guides(colour = guide_legend(override.aes = list(size = 5))) +
  scale_color_manual(values = palette_duration) +
  theme_map() +
  theme(legend.title = element_blank())

```

# 6.5 Relative to reef surface

```{r}

load(file = "../data/04_reef-surface-by-ecoregion.RData")

data_surface <- left_join(data_surface, data_descriptors) %>% 
  select(-n_1, -n_2_5, -n_6_10, -n_11_15) %>% 
  mutate(n_sites_100 = (n_sites*1000)/area)

ggplot(data = data_surface) +
  geom_point(aes(x = ECOREGION, y = n_sites_100))
  
hist(data_surface$n_sites_100)


```

```{r fig.height=15, fig.width=5}

# 1. Transform the data ----

data_descriptors <- data_descriptors %>% 
  mutate(color = "#446cb3",
         name = glue("{ECOREGION} (<b style='color:{color}'>{ECO_CODE_X}</b>)"),
         name = fct_rev(name))

# 2. Make the plot ----

ggplot(data = data_descriptors, aes(x = name, y = n_sites)) +
  geom_point() +
  coord_flip() +
  theme(axis.text.y = element_markdown()) +
  labs(x = NULL)
  
# 3. Save the plot ----

ggsave(filename = "../figs/07_ecoregions-sites.png", height = 15, width = 5)

```

# Reproducibility

```{r reprod}

# 1. Reproducibility ----

sessionInfo()

```

---
Jeremy WICQUART | jeremywicquart@gmail.com | `r format(Sys.time())`